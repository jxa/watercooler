<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" dir="ltr">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <script src="/javascript/jquery.js" type="text/javascript"></script>
    <link href="/stylesheet/screen.css" type="text/css" rel="stylesheet">
    <title>Watercooler Chat - %room%</title>
    <script type="text/javascript">
  var newest_message=0;
  var intervalID;

  function add_messages(data){
    $.each(data, function(i,item){
      $("<dd/>").text(item.body).prependTo("#messages");
      $("<dt/>").text(item.author).prependTo("#messages");      
      newest_message = item.id;
    });
  }

  function new_messages(){
    url = "/api/messages/%room%"
    if(newest_message!=0){ url = url+"?newer_than="+newest_message; };
    $.getJSON(url,
        function(data){
          add_messages(data);
        });
  }
  
  function get_messages_now(){
    clearInterval(intervalID);
    new_messages();
    intervalID = setInterval(new_messages, 5000);
  }

  $(document).ready(function(){
    new_messages(); 
    intervalID = setInterval(new_messages, 5000);
    $("message_box").keypress(function(event){alert(event);});
  });
  </script>

<!-- onKeyPress: function(event) { -->
<!--   this.chat.dispatch('preparationForKeyPress', event); -->
<!--   switch (event.keyCode) { -->
<!--     case Event.KEY_RETURN: -->
<!--     case 3: /* safari sends ASCII 3 for the enter key */ -->
<!--       if (event.shiftKey) { -->
<!--         return; -->
<!--       } else if (event.ctrlKey || event.metaKey) { -->
<!--         this.send(true); -->
<!--       } else { -->
<!--         this.send(); -->
<!--       } -->
<!--       Event.stop(event); -->
<!--     } -->
<!--   }, -->

  </head>
  <body>
    <div id="wrapper">
      <h1>%room%</h1>
      <div id="topic">%topic%</div>
      <div id="form_div">
        <form id="new_message" onsubmit="$.post('/api/messages/%room%', $('form').serialize(), function(data){get_messages_now();}); return false;">
          <textarea id="message_box" rows="2" cols="50" name="body"></textarea>
          <input type="hidden" name="type" value="msg"/>
          <input type="hidden" name="author" value="xandrews"/>
          <input type="submit" name="submit" value="Send Message"/>
        </form>
      </div>
      <div id="content">
        <dl id="messages"></dl>
      </div>
    </div><!-- end of wrapper -->
  </body>
</html>
